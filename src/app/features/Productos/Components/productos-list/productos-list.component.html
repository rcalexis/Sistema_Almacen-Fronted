<div class="p-6 md:p-8">
  <p-toast></p-toast>
  <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

  <p-toolbar styleClass="mb-4 rounded-lg shadow-md">
    <ng-template pTemplate="start">
      <h2 class="text-2xl font-bold text-gray-700">Lista de Productos</h2>
    </ng-template>
    
    <ng-template pTemplate="end">
      <button 
        *ngIf="usuarioRol === 'Administrador'"
        pButton 
        label="Agregar Producto" 
        icon="pi pi-plus" 
        class="p-button-success" 
        (click)="router.navigate(['/products/crear'])">
      </button>
    </ng-template>
  </p-toolbar>

  <div class="card shadow-md rounded-lg overflow-hidden">
    <p-table [value]="productos" [paginator]="true" [rows]="10" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="nombre">Nombre <p-sortIcon field="nombre"></p-sortIcon></th>
          <th pSortableColumn="descripcion">Descripción <p-sortIcon field="descripcion"></p-sortIcon></th>
          <th pSortableColumn="cantidad_actual" class="text-center">Cantidad <p-sortIcon field="cantidad_actual"></p-sortIcon></th>
          <th pSortableColumn="estatus" class="text-center">Estatus <p-sortIcon field="estatus"></p-sortIcon></th>
          <th pSortableColumn="nombre_creador">Creado por <p-sortIcon field="nombre_creador"></p-sortIcon></th>
          <th class="text-center">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-producto>
        <tr>
          <td>{{ producto.nombre }}</td>
          <td>{{ producto.descripcion }}</td>
          <td class="text-center">{{ producto.cantidad_actual }}</td>
          <td class="text-center">
            <span [class]="producto.estatus ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 py-1 text-xs font-medium rounded-full">
              {{ producto.estatus ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>{{ producto.nombre_creador }}</td>
          <td class="text-center">
            <div class="flex items-center justify-center gap-2">

              <ng-container *ngIf="usuarioRol === 'Administrador'">
                <button *ngIf="producto.estatus" pButton icon="pi pi-plus" class="p-button-rounded p-button-success p-button-text" pTooltip="Aumentar inventario" (click)="abrirDialogo(producto, 'aumentar')"></button>
                <button *ngIf="producto.estatus" pButton icon="pi pi-arrow-down" class="p-button-rounded p-button-warning p-button-text" pTooltip="Dar de baja" (click)="confirmarBaja(producto)"></button>
                <button *ngIf="!producto.estatus" pButton icon="pi pi-check" class="p-button-rounded p-button-info p-button-text" pTooltip="Reactivar producto" (click)="reactivar(producto.id_producto)"></button>
              </ng-container>

              <ng-container *ngIf="usuarioRol === 'Almacenista'">
                <button *ngIf="producto.estatus" pButton icon="pi pi-minus" class="p-button-rounded p-button-danger p-button-text" pTooltip="Sacar de inventario" (click)="abrirDialogo(producto, 'sacar')" [disabled]="producto.cantidad_actual <= 0"></button>
              </ng-container>

            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center p-4">No se encontraron productos.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog
    [header]="accionInventario === 'aumentar' ? 'Aumentar Inventario' : 'Sacar de Inventario'"
    [(visible)]="displayDialog"
    [modal]="true"
    [style]="{width: '400px'}"
    (onHide)="productoSeleccionado=null; accionInventario=null;">

    <div *ngIf="productoSeleccionado" class="flex flex-col gap-4">
      <p><strong>Producto:</strong> {{ productoSeleccionado.nombre }}</p>
      <p><strong>Cantidad actual:</strong> {{ productoSeleccionado.cantidad_actual }}</p>
      
      <div class="p-fluid">
        <label for="cantidad" class="block mb-2 font-medium">Cantidad:</label>
        <p-inputNumber
          id="cantidad"
          [(ngModel)]="cantidadInput"
          (onInput)="onCantidadChange($event)"
          mode="decimal"
          [showButtons]="true"
          [min]="1"
          [max]="accionInventario === 'sacar' ? productoSeleccionado.cantidad_actual : 100000"
          inputId="minmax"
          placeholder="Ingrese cantidad">
        </p-inputNumber>
        
        <small *ngIf="accionInventario === 'sacar' && cantidadInput > productoSeleccionado.cantidad_actual" 
              class="p-error block mt-1">
          No puede sacar más de {{ productoSeleccionado.cantidad_actual }} unidades
        </small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog=false"></button>
      <button pButton 
              label="Guardar" 
              icon="pi pi-check" 
              (click)="gestionarInventario()" 
              [disabled]="!cantidadInput || cantidadInput < 1 || (accionInventario === 'sacar' && productoSeleccionado && cantidadInput > productoSeleccionado.cantidad_actual)"
              class="p-button-success">
      </button>
    </ng-template>
  </p-dialog>
</div>