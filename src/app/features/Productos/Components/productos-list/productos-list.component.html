<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-4 sm:p-6 lg:p-8">
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    
    <div class="px-6 py-5 flex flex-wrap justify-between items-end gap-4 border-b border-gray-200">
      
      <div class="flex flex-col gap-3">
        <h2 class="text-2xl font-bold text-gray-800">
          <i class="pi pi-box mr-2"></i>Lista de Productos
        </h2>
        <p class="text-sm text-gray-500">Administra los productos del sistema.</p>
        <button 
          *ngIf="usuarioRol === 'Administrador'"
          pButton 
          pRipple 
          label="Nuevo Producto" 
          icon="pi pi-plus" 
          class="p-button-success"
          (click)="router.navigate(['/products/crear'])">
        </button>
      </div>
      
      <div class="flex items-center">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            pInputText 
            type="text" 
            (input)="onSearch(productTable, $event)" 
            placeholder="Buscar..."
            class="p-inputtext-sm modern-search" 
          />
        </span>
      </div>
    </div>

    <p-table 
      #productTable
      [value]="productos" 
      [paginator]="true" 
      [rows]="10" 
      styleClass="p-datatable-striped" 
      [tableStyle]="{'min-width': '50rem'}"
      [globalFilterFields]="['nombre', 'descripcion', 'nombre_creador']"> 
      
      <ng-template pTemplate="header">
        <tr>
          <th class="p-4 text-left text-sm font-semibold text-white bg-gray-800">Nombre</th>
          <th class="p-4 text-left text-sm font-semibold text-white bg-gray-800">Descripción</th>
          <th class="p-4 text-center text-sm font-semibold text-white bg-gray-800">Cantidad</th>
          <th class="p-4 text-center text-sm font-semibold text-white bg-gray-800">Estatus</th>
          <th class="p-4 text-left text-sm font-semibold text-white bg-gray-800">Creado por</th>
          <th class="p-4 text-center text-sm font-semibold text-white bg-gray-800">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-producto>
        <tr>
          <td class="p-4 whitespace-nowrap text-sm text-gray-800">{{ producto.nombre }}</td>
          <td class="p-4 whitespace-nowrap text-sm text-gray-800">{{ producto.descripcion }}</td>
          <td class="p-4 whitespace-nowrap text-sm text-gray-800 text-center">{{ producto.cantidad_actual }}</td>
          <td class="p-4 whitespace-nowrap text-center">
            <p-tag 
              [severity]="producto.estatus ? 'success' : 'danger'" 
              [value]="producto.estatus ? 'Activo' : 'Inactivo'">
            </p-tag>
          </td>
          <td class="p-4 whitespace-nowrap text-sm text-gray-800">{{ producto.nombre_creador }}</td>
          <td class="p-4 whitespace-nowrap">
            <div class="flex items-center justify-center gap-2">
              <ng-container *ngIf="usuarioRol === 'Administrador'">
                <button *ngIf="producto.estatus" pButton pRipple icon="pi pi-plus" class="p-button-rounded p-button-success" pTooltip="Aumentar inventario" (click)="abrirDialogo(producto, 'aumentar')"></button>
                <button *ngIf="producto.estatus" pButton pRipple icon="pi pi-arrow-down" class="p-button-rounded p-button-warning" pTooltip="Dar de baja" (click)="confirmarBaja(producto)"></button>
                <button *ngIf="!producto.estatus" pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-info" pTooltip="Reactivar producto" (click)="reactivar(producto.id_producto)"></button>
              </ng-container>
              <ng-container *ngIf="usuarioRol === 'Almacenista'">
                <button *ngIf="producto.estatus" pButton pRipple icon="pi pi-minus" class="p-button-rounded p-button-danger" pTooltip="Sacar de inventario" (click)="abrirDialogo(producto, 'sacar')" [disabled]="producto.cantidad_actual <= 0"></button>
              </ng-container>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center p-8">
            <div class="flex flex-col items-center justify-center text-gray-500">
              <i class="pi pi-inbox text-5xl mb-3"></i>
              <span class="font-bold">No se encontraron productos.</span>
              <span>Intenta mas tarde.</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-dialog
  [header]="accionInventario === 'aumentar' ? 'Aumentar Inventario' : 'Sacar de Inventario'"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{width: '400px'}"
  (onHide)="productoSeleccionado=null; accionInventario=null;">

  <div *ngIf="productoSeleccionado" class="flex flex-col gap-4">
    <p><strong>Producto:</strong> {{ productoSeleccionado.nombre }}</p>
    <p><strong>Cantidad actual:</strong> {{ productoSeleccionado.cantidad_actual }}</p>
    
    <div class="p-fluid">
      <label for="cantidad" class="block mb-2 font-medium">Cantidad:</label>
      <p-inputNumber
        id="cantidad"
        [(ngModel)]="cantidadInput"
        (onInput)="onCantidadChange($event)"
        mode="decimal"
        [showButtons]="true"
        [min]="1"
        [max]="accionInventario === 'sacar' ? productoSeleccionado.cantidad_actual : 100000"
        inputId="minmax"
        placeholder="Ingrese cantidad">
      </p-inputNumber>
      
      <small *ngIf="accionInventario === 'sacar' && productoSeleccionado && cantidadInput > productoSeleccionado.cantidad_actual" 
             class="p-error block mt-1">
        No puede sacar más de {{ productoSeleccionado.cantidad_actual }} unidades
      </small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog=false"></button>
    <button pButton 
            label="Guardar" 
            icon="pi pi-check" 
            (click)="gestionarInventario()" 
            [disabled]="!cantidadInput || cantidadInput < 1 || (accionInventario === 'sacar' && productoSeleccionado && cantidadInput > productoSeleccionado.cantidad_actual)"
            class="p-button-success">
    </button>
  </ng-template>
</p-dialog>